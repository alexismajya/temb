"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const url = require("url");
var CypressRunningMode;
(function (CypressRunningMode) {
    CypressRunningMode["Console"] = "console";
    CypressRunningMode["Browser"] = "browser";
})(CypressRunningMode = exports.CypressRunningMode || (exports.CypressRunningMode = {}));
class CypressBuilder {
    constructor(context) {
        this.context = context;
    }
    run(builderConfig) {
        const options = Object.assign({}, builderConfig.options, { project: builderConfig.root });
        return rxjs_1.of(null).pipe(operators_1.concatMap(() => options.devServerTarget ? this._startDevServer(options) : rxjs_1.of(null)), operators_1.concatMap(() => this._execute(options)), operators_1.take(1));
    }
    // Note: this method mutates the options argument.
    _startDevServer(options) {
        const architect = this.context.architect;
        const [project, targetName, configuration] = options.devServerTarget.split(":");
        // Override browser build watch setting.
        const overrides = { watch: false, host: options.host, port: options.port };
        const targetSpec = {
            project,
            target: targetName,
            configuration,
            overrides
        };
        const builderConfig = architect.getBuilderConfiguration(targetSpec);
        let devServerDescription;
        let baseUrl;
        return architect.getBuilderDescription(builderConfig).pipe(operators_1.tap(description => (devServerDescription = description)), operators_1.concatMap(description => architect.validateBuilderOptions(builderConfig, description)), operators_1.concatMap(() => {
            // Compute baseUrl from devServerOptions.
            if (options.devServerTarget && builderConfig.options.publicHost) {
                let publicHost = builderConfig.options.publicHost;
                if (!/^\w+:\/\//.test(publicHost)) {
                    publicHost = `${builderConfig.options.ssl ? "https" : "http"}://${publicHost}`;
                }
                const clientUrl = url.parse(publicHost);
                baseUrl = url.format(clientUrl);
            }
            else if (options.devServerTarget) {
                baseUrl = url.format({
                    protocol: builderConfig.options.ssl ? "https" : "http",
                    hostname: options.host,
                    port: builderConfig.options.port.toString()
                });
            }
            // Save the computed baseUrl back so that Protractor can use it.
            options.baseUrl = baseUrl;
            return rxjs_1.of(this.context.architect.getBuilder(devServerDescription, this.context));
        }), operators_1.concatMap(builder => builder.run(builderConfig)));
    }
    _execute(options) {
        const additionalCypressConfig = Object.assign({ config: {
                baseUrl: options.baseUrl
            } }, (options.ciBuildId ? { ciBuildId: options.ciBuildId } : {}), (options.env ? { env: options.env } : {}), (options.group ? { group: options.group } : {}), (options.key ? { key: options.key } : {}), (options.parallel ? { parallel: options.parallel } : {}), (options.project ? { project: options.project } : {}), (options.record ? { record: options.record } : {}), (options.reporter ? { reporter: options.reporter } : {}), (options.reporterPath ? { reporter: options.reporterPath } : {}), (options.spec ? { spec: options.spec } : {}));
        const cypress = require("cypress");
        const runner = options.mode === CypressRunningMode.Console
            ? rxjs_1.from(cypress.run(additionalCypressConfig))
                .pipe(operators_1.map((result) => ({ success: result.totalFailed === 0 })))
            : cypress.open(additionalCypressConfig);
        return rxjs_1.from(runner);
    }
}
exports.CypressBuilder = CypressBuilder;
exports.default = CypressBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3lwcmVzcy1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9pc2FhYy9Eb2N1bWVudHMvQ29udHJpYnV0aW9ucy9uZ3gtY3lwcmVzcy1idWlsZGVyL2xpYi8iLCJzb3VyY2VzIjpbInNyYy9jeXByZXNzL2N5cHJlc3MtYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQWNBLCtCQUE0QztBQUM1Qyw4Q0FBMkQ7QUFDM0QsMkJBQTJCO0FBRTNCLElBQVksa0JBR1g7QUFIRCxXQUFZLGtCQUFrQjtJQUM1Qix5Q0FBbUIsQ0FBQTtJQUNuQix5Q0FBbUIsQ0FBQTtBQUNyQixDQUFDLEVBSFcsa0JBQWtCLEdBQWxCLDBCQUFrQixLQUFsQiwwQkFBa0IsUUFHN0I7QUFvQkQ7SUFDRSxZQUFtQixPQUF1QjtRQUF2QixZQUFPLEdBQVAsT0FBTyxDQUFnQjtJQUFHLENBQUM7SUFFOUMsR0FBRyxDQUNELGFBQTBEO1FBRTFELE1BQU0sT0FBTyxxQkFDUixhQUFhLENBQUMsT0FBTyxJQUN4QixPQUFPLEVBQUUsYUFBYSxDQUFDLElBQUksR0FDNUIsQ0FBQztRQUVGLE9BQU8sU0FBRSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FDbEIscUJBQVMsQ0FDUCxHQUFHLEVBQUUsQ0FDSCxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFFLENBQUMsSUFBSSxDQUFDLENBQ3JFLEVBQ0QscUJBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQ3ZDLGdCQUFJLENBQUMsQ0FBQyxDQUFDLENBQ1IsQ0FBQztJQUNKLENBQUM7SUFFRCxrREFBa0Q7SUFDMUMsZUFBZSxDQUFDLE9BQThCO1FBQ3BELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDO1FBQ3pDLE1BQU0sQ0FDSixP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TyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFDekMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUMvQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQ3pDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFDeEQsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUNyRCxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQ2xELENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFDeEQsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUNoRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQ2hELENBQUM7UUFDRixNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbkMsTUFBTSxNQUFNLEdBQ1YsT0FBTyxDQUFDLElBQUksS0FBSyxrQkFBa0IsQ0FBQyxPQUFPO1lBQ3pDLENBQUMsQ0FBQyxXQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO2lCQUN2QyxJQUFJLENBQUMsZUFBRyxDQUFDLENBQUMsTUFBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxXQUFXLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3hFLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFFNUMsT0FBTyxXQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdEIsQ0FBQztDQUNGO0FBeEdELHdDQXdHQztBQUVELGtCQUFlLGNBQWMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBAbGljZW5zZVxyXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cclxuICpcclxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcclxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxyXG4gKi9cclxuaW1wb3J0IHtcclxuICBCdWlsZGVyLFxyXG4gIEJ1aWxkZXJDb25maWd1cmF0aW9uLFxyXG4gIEJ1aWxkZXJDb250ZXh0LFxyXG4gIEJ1aWxkZXJEZXNjcmlwdGlvbixcclxuICBCdWlsZEV2ZW50XHJcbn0gZnJvbSBcIkBhbmd1bGFyLWRldmtpdC9hcmNoaXRlY3RcIjtcclxuaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQgeyBjb25jYXRNYXAsIG1hcCwgdGFrZSwgdGFwIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcbmltcG9ydCAqIGFzIHVybCBmcm9tIFwidXJsXCI7XHJcblxyXG5leHBvcnQgZW51bSBDeXByZXNzUnVubmluZ01vZGUge1xyXG4gIENvbnNvbGUgPSBcImNvbnNvbGVcIixcclxuICBCcm93c2VyID0gXCJicm93c2VyXCJcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDeXByZXNzQnVpbGRlck9wdGlvbnMge1xyXG4gIGRldlNlcnZlclRhcmdldD86IHN0cmluZztcclxuICBtb2RlPzogc3RyaW5nO1xyXG4gIGJhc2VVcmw/OiBzdHJpbmc7XHJcbiAgaG9zdD86IHN0cmluZztcclxuICBjaUJ1aWxkSWQ/OiBzdHJpbmc7XHJcbiAgZW52Pzogb2JqZWN0O1xyXG4gIGdyb3VwPzogc3RyaW5nO1xyXG4gIGtleT86IHN0cmluZztcclxuICBwYXJhbGxlbD86IGJvb2xlYW47XHJcbiAgcG9ydD86IG51bWJlcjtcclxuICBwcm9qZWN0Pzogc3RyaW5nO1xyXG4gIHJlY29yZD86IGJvb2xlYW47XHJcbiAgcmVwb3J0ZXI/OiBzdHJpbmc7XHJcbiAgcmVwb3J0ZXJQYXRoPzogc3RyaW5nO1xyXG4gIHNwZWM/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBDeXByZXNzQnVpbGRlciBpbXBsZW1lbnRzIEJ1aWxkZXI8Q3lwcmVzc0J1aWxkZXJPcHRpb25zPiB7XHJcbiAgY29uc3RydWN0b3IocHVibGljIGNvbnRleHQ6IEJ1aWxkZXJDb250ZXh0KSB7fVxyXG5cclxuICBydW4oXHJcbiAgICBidWlsZGVyQ29uZmlnOiBCdWlsZGVyQ29uZmlndXJhdGlvbjxDeXByZXNzQnVpbGRlck9wdGlvbnM+XHJcbiAgKTogT2JzZXJ2YWJsZTxCdWlsZEV2ZW50PiB7XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICAuLi5idWlsZGVyQ29uZmlnLm9wdGlvbnMsXHJcbiAgICAgIHByb2plY3Q6IGJ1aWxkZXJDb25maWcucm9vdFxyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4gb2YobnVsbCkucGlwZShcclxuICAgICAgY29uY2F0TWFwKFxyXG4gICAgICAgICgpID0+XHJcbiAgICAgICAgICBvcHRpb25zLmRldlNlcnZlclRhcmdldCA/IHRoaXMuX3N0YXJ0RGV2U2VydmVyKG9wdGlvbnMpIDogb2YobnVsbClcclxuICAgICAgKSxcclxuICAgICAgY29uY2F0TWFwKCgpID0+IHRoaXMuX2V4ZWN1dGUob3B0aW9ucykpLFxyXG4gICAgICB0YWtlKDEpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8gTm90ZTogdGhpcyBtZXRob2QgbXV0YXRlcyB0aGUgb3B0aW9ucyBhcmd1bWVudC5cclxuICBwcml2YXRlIF9zdGFydERldlNlcnZlcihvcHRpb25zOiBDeXByZXNzQnVpbGRlck9wdGlvbnMpIHtcclxuICAgIGNvbnN0IGFyY2hpdGVjdCA9IHRoaXMuY29udGV4dC5hcmNoaXRlY3Q7XHJcbiAgICBjb25zdCBbXHJcbiAgICAgIHByb2plY3QsXHJcbiAgICAgIHRhcmdldE5hbWUsXHJcbiAgICAgIGNvbmZpZ3VyYXRpb25cclxuICAgIF0gPSAob3B0aW9ucy5kZXZTZXJ2ZXJUYXJnZXQgYXMgc3RyaW5nKS5zcGxpdChcIjpcIik7XHJcbiAgICAvLyBPdmVycmlkZSBicm93c2VyIGJ1aWxkIHdhdGNoIHNldHRpbmcuXHJcbiAgICBjb25zdCBvdmVycmlkZXMgPSB7IHdhdGNoOiBmYWxzZSwgaG9zdDogb3B0aW9ucy5ob3N0LCBwb3J0OiBvcHRpb25zLnBvcnQgfTtcclxuICAgIGNvbnN0IHRhcmdldFNwZWMgPSB7XHJcbiAgICAgIHByb2plY3QsXHJcbiAgICAgIHRhcmdldDogdGFyZ2V0TmFtZSxcclxuICAgICAgY29uZmlndXJhdGlvbixcclxuICAgICAgb3ZlcnJpZGVzXHJcbiAgICB9O1xyXG4gICAgY29uc3QgYnVpbGRlckNvbmZpZyA9IGFyY2hpdGVjdC5nZXRCdWlsZGVyQ29uZmlndXJhdGlvbjxhbnk+KHRhcmdldFNwZWMpO1xyXG4gICAgbGV0IGRldlNlcnZlckRlc2NyaXB0aW9uOiBCdWlsZGVyRGVzY3JpcHRpb247XHJcbiAgICBsZXQgYmFzZVVybDogc3RyaW5nO1xyXG5cclxuICAgIHJldHVybiBhcmNoaXRlY3QuZ2V0QnVpbGRlckRlc2NyaXB0aW9uKGJ1aWxkZXJDb25maWcpLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICBkZXNjcmlwdGlvbiA9PlxyXG4gICAgICAgICAgKGRldlNlcnZlckRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb24gYXMgQnVpbGRlckRlc2NyaXB0aW9uKVxyXG4gICAgICApLFxyXG4gICAgICBjb25jYXRNYXAoZGVzY3JpcHRpb24gPT5cclxuICAgICAgICBhcmNoaXRlY3QudmFsaWRhdGVCdWlsZGVyT3B0aW9ucyhidWlsZGVyQ29uZmlnLCBkZXNjcmlwdGlvbilcclxuICAgICAgKSxcclxuICAgICAgY29uY2F0TWFwKCgpID0+IHtcclxuICAgICAgICAvLyBDb21wdXRlIGJhc2VVcmwgZnJvbSBkZXZTZXJ2ZXJPcHRpb25zLlxyXG4gICAgICAgIGlmIChvcHRpb25zLmRldlNlcnZlclRhcmdldCAmJiBidWlsZGVyQ29uZmlnLm9wdGlvbnMucHVibGljSG9zdCkge1xyXG4gICAgICAgICAgbGV0IHB1YmxpY0hvc3QgPSBidWlsZGVyQ29uZmlnLm9wdGlvbnMucHVibGljSG9zdDtcclxuICAgICAgICAgIGlmICghL15cXHcrOlxcL1xcLy8udGVzdChwdWJsaWNIb3N0KSkge1xyXG4gICAgICAgICAgICBwdWJsaWNIb3N0ID0gYCR7XHJcbiAgICAgICAgICAgICAgYnVpbGRlckNvbmZpZy5vcHRpb25zLnNzbCA/IFwiaHR0cHNcIiA6IFwiaHR0cFwiXHJcbiAgICAgICAgICAgIH06Ly8ke3B1YmxpY0hvc3R9YDtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnN0IGNsaWVudFVybCA9IHVybC5wYXJzZShwdWJsaWNIb3N0KTtcclxuICAgICAgICAgIGJhc2VVcmwgPSB1cmwuZm9ybWF0KGNsaWVudFVybCk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLmRldlNlcnZlclRhcmdldCkge1xyXG4gICAgICAgICAgYmFzZVVybCA9IHVybC5mb3JtYXQoe1xyXG4gICAgICAgICAgICBwcm90b2NvbDogYnVpbGRlckNvbmZpZy5vcHRpb25zLnNzbCA/IFwiaHR0cHNcIiA6IFwiaHR0cFwiLFxyXG4gICAgICAgICAgICBob3N0bmFtZTogb3B0aW9ucy5ob3N0LFxyXG4gICAgICAgICAgICBwb3J0OiBidWlsZGVyQ29uZmlnLm9wdGlvbnMucG9ydC50b1N0cmluZygpXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIFNhdmUgdGhlIGNvbXB1dGVkIGJhc2VVcmwgYmFjayBzbyB0aGF0IFByb3RyYWN0b3IgY2FuIHVzZSBpdC5cclxuICAgICAgICBvcHRpb25zLmJhc2VVcmwgPSBiYXNlVXJsO1xyXG5cclxuICAgICAgICByZXR1cm4gb2YoXHJcbiAgICAgICAgICB0aGlzLmNvbnRleHQuYXJjaGl0ZWN0LmdldEJ1aWxkZXIoZGV2U2VydmVyRGVzY3JpcHRpb24sIHRoaXMuY29udGV4dClcclxuICAgICAgICApO1xyXG4gICAgICB9KSxcclxuICAgICAgY29uY2F0TWFwKGJ1aWxkZXIgPT4gYnVpbGRlci5ydW4oYnVpbGRlckNvbmZpZykpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfZXhlY3V0ZShvcHRpb25zOiBDeXByZXNzQnVpbGRlck9wdGlvbnMpOiBPYnNlcnZhYmxlPEJ1aWxkRXZlbnQ+IHtcclxuICAgIGNvbnN0IGFkZGl0aW9uYWxDeXByZXNzQ29uZmlnID0ge1xyXG4gICAgICBjb25maWc6IHtcclxuICAgICAgICBiYXNlVXJsOiBvcHRpb25zLmJhc2VVcmxcclxuICAgICAgfSxcclxuICAgICAgLi4uKG9wdGlvbnMuY2lCdWlsZElkID8geyBjaUJ1aWxkSWQ6IG9wdGlvbnMuY2lCdWlsZElkIH0gOiB7fSksXHJcbiAgICAgIC4uLihvcHRpb25zLmVudiA/IHsgZW52OiBvcHRpb25zLmVudiB9IDoge30pLFxyXG4gICAgICAuLi4ob3B0aW9ucy5ncm91cCA/IHsgZ3JvdXA6IG9wdGlvbnMuZ3JvdXAgfSA6IHt9KSxcclxuICAgICAgLi4uKG9wdGlvbnMua2V5ID8geyBrZXk6IG9wdGlvbnMua2V5IH0gOiB7fSksXHJcbiAgICAgIC4uLihvcHRpb25zLnBhcmFsbGVsID8geyBwYXJhbGxlbDogb3B0aW9ucy5wYXJhbGxlbCB9IDoge30pLFxyXG4gICAgICAuLi4ob3B0aW9ucy5wcm9qZWN0ID8geyBwcm9qZWN0OiBvcHRpb25zLnByb2plY3QgfSA6IHt9KSxcclxuICAgICAgLi4uKG9wdGlvbnMucmVjb3JkID8geyByZWNvcmQ6IG9wdGlvbnMucmVjb3JkIH0gOiB7fSksXHJcbiAgICAgIC4uLihvcHRpb25zLnJlcG9ydGVyID8geyByZXBvcnRlcjogb3B0aW9ucy5yZXBvcnRlciB9IDoge30pLFxyXG4gICAgICAuLi4ob3B0aW9ucy5yZXBvcnRlclBhdGggPyB7IHJlcG9ydGVyOiBvcHRpb25zLnJlcG9ydGVyUGF0aCB9IDoge30pLFxyXG4gICAgICAuLi4ob3B0aW9ucy5zcGVjID8geyBzcGVjOiBvcHRpb25zLnNwZWMgfSA6IHt9KVxyXG4gICAgfTtcclxuICAgIGNvbnN0IGN5cHJlc3MgPSByZXF1aXJlKFwiY3lwcmVzc1wiKTtcclxuICAgIGNvbnN0IHJ1bm5lciA9XHJcbiAgICAgIG9wdGlvbnMubW9kZSA9PT0gQ3lwcmVzc1J1bm5pbmdNb2RlLkNvbnNvbGVcclxuICAgICAgICA/IGZyb20oY3lwcmVzcy5ydW4oYWRkaXRpb25hbEN5cHJlc3NDb25maWcpKVxyXG4gICAgICAgICAgICAucGlwZShtYXAoKHJlc3VsdDogYW55KSA9PiAoeyBzdWNjZXNzOiByZXN1bHQudG90YWxGYWlsZWQgPT09IDAgfSkpKVxyXG4gICAgICAgIDogY3lwcmVzcy5vcGVuKGFkZGl0aW9uYWxDeXByZXNzQ29uZmlnKTtcclxuXHJcbiAgICByZXR1cm4gZnJvbShydW5uZXIpO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgQ3lwcmVzc0J1aWxkZXI7XHJcbiJdfQ==